#!/usr/bin/python

""" Script to estimate initial values for CFD Simulations"""


class FlowMetric:
    """A class to define the attributes of a flow metric"""
    def __init__(self, name: str, symbol: str, value: float = None):
        self.description = name
        self.symbol = symbol
        self.value = value


class FlowMetrics:
    """A class to contain all flow metrics"""

    def __init__(self):
        # Initialize all metrics as FlowMetric objects
        self.hydraulic_diameter = FlowMetric("Hydraulic Diameter", "D_h")
        self.free_stream_velocity = FlowMetric("Free Stream Velocity", "U_inf")
        self.kinematic_viscosity = FlowMetric("Kinematic Viscosity", "nu")
        self.reynolds_number = FlowMetric("Reynolds Number", "Re")
        self.turb_intensity = FlowMetric("Turbulence Intensity", "I")
        self.turb_kinetic_energy = FlowMetric("Turbulence Kinetic Energy", "k")
        self.turb_length_scale = FlowMetric("Turbulence Length Scale", "l_t")
        self.turb_dissipation_rate = FlowMetric("Turbulence Dissipation Rate", "epsilon")
        self.specific_dissipation = FlowMetric("Specific Dissipation Rate", "omega")
        self.turb_viscosity = FlowMetric("Turbulent Viscosity", "mu_t")

        # Execute methods in the correct order during initialization
        self.collect_inputs()
        self.perform_calculations()

    def collect_inputs(self):
        """Get input values for the key flow metrics"""
        self.hydraulic_diameter.value = self.get_metric("Enter the hydraulic diameter (m): ")
        self.free_stream_velocity.value = self.get_metric("Enter the free stream velocity (m/s): ")
        print("Typical values for Kinematic viscosity (m²/s):\n  - Water: 0.000001\n  - Air: 0.0000148")
        self.kinematic_viscosity.value = self.get_metric("Enter the kinematic viscosity (m²/s): ")

    def perform_calculations(self):
        """Perform all calculations in the correct order"""

        # Reynolds Number
        self.reynolds_number.value = self.calc_reynolds_number(self.hydraulic_diameter.value,
                                                               self.free_stream_velocity.value,
                                                               self.kinematic_viscosity.value)

        # Turbulence Intensity
        self.turb_intensity.value = self.calc_turb_intensity(self.reynolds_number.value)

        # Turbulence Kinetic Energy
        self.turb_kinetic_energy.value = self.calc_turb_kinetic_energy(self.free_stream_velocity.value,
                                                                       self.turb_intensity.value)

        # Turbulence Length Scale
        self.turb_length_scale.value = self.calc_turb_length_scale(self.hydraulic_diameter.value)

        # Turbulence Dissipation Rate (epsilon)
        self.turb_dissipation_rate.value = self.calc_turb_dissipation_rate(self.turb_kinetic_energy.value,
                                                                           self.turb_length_scale.value)

        # Specific Dissipation Rate (omega)
        self.specific_dissipation.value = self.calc_specific_turb_dissipation_rate(self.turb_kinetic_energy.value,
                                                                                   self.turb_length_scale.value)

        # Turbulent Viscosity (using epsilon method)
        self.turb_viscosity.value = self.calc_turb_viscosity_epsilon(self.turb_kinetic_energy.value,
                                                                     self.turb_dissipation_rate.value)

    def __repr__(self):
        """Define custom print method for easy visualization of results"""
        print('Resulting flow metrics:')
        return "\n".join(f"{attr} ({getattr(self, attr).symbol}): { float('%.*g' % (3, getattr(self, attr).value))}"
                         for attr in vars(self) if isinstance(getattr(self, attr), FlowMetric))

    # ------------------- Calculation Methods -------------------

    def calc_reynolds_number(self, length: float, velocity: float, kinematic_viscosity: float):
        return length * velocity / kinematic_viscosity

    def calc_turb_intensity(self, reynolds_number: float):
        turb_coefficient = 0.16
        return turb_coefficient * reynolds_number ** (-1 / 8)

    def calc_turb_kinetic_energy(self, velocity: float, turb_intensity: float):
        return (3 / 2) * (velocity * turb_intensity) ** 2

    def calc_turb_length_scale(self, hydraulic_diameter: float):
        coefficient_for_pipe_flow = 0.07
        return hydraulic_diameter * coefficient_for_pipe_flow

    def calc_turb_dissipation_rate(self, turbulent_kinetic_energy: float, turbulent_length_scale: float):
        model_function = 0.09
        return model_function ** (3 / 4) * turbulent_kinetic_energy ** (3 / 2) / turbulent_length_scale

    def calc_specific_turb_dissipation_rate(self, turbulent_kinetic_energy: float, turbulent_length_scale: float):
        model_function = 0.09
        return turbulent_kinetic_energy ** 0.5 / (model_function ** (1 / 4) * turbulent_length_scale)

    def calc_turb_viscosity_epsilon(self, turb_kinetic_energy: float, turb_dissipation_rate: float):
        model_function = 0.09
        return model_function * turb_kinetic_energy ** 2 / turb_dissipation_rate

    def get_metric(self, prompt: str):
        while True:
            try:
                metric = float(input(prompt))
                if metric <= 0:
                    raise ValueError("Value must be positive")
                return metric
            except ValueError as e:
                print(f"Invalid input: {e}")


def create_flow_metrics():
    flow_metrics = FlowMetrics()
    print(flow_metrics)
    return flow_metrics


if __name__ == "__main__":
    create_flow_metrics()



