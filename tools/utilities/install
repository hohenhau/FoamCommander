#!/bin/bash
# Set variables
NAME="foco"
COMPLETION_FILE="foco-completion.bash"
COMPLETION_DIR="completion"

# Detect the location of the install script
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Find the base directory by going up one level from the utilities folder
BASE_DIR="$(cd "$SCRIPT_DIR/../.." && pwd)"

# Path to completion file inside the repo
COMPLETION_PATH="$BASE_DIR/$COMPLETION_DIR/$COMPLETION_FILE"

# Ensure the completion file exists
if [ ! -f "$COMPLETION_PATH" ]; then
    echo "Error: Completion file not found at $COMPLETION_PATH"
    exit 1
fi

# Bashrc path
BASHRC="$HOME/.bashrc"

# Define the desired line to source the completion script
SOURCE_LINE="source \"$COMPLETION_PATH\""

# Remove any old references to completion file pointing to different paths
# This handles cases where the user moved the installation folder
sed -i "/$COMPLETION_FILE/d" "$BASHRC"

# Add new source line if not already present
if ! grep -Fxq "$SOURCE_LINE" "$BASHRC"; then
    echo "$SOURCE_LINE" >> "$BASHRC"
    echo "Added $NAME completion to ~/.bashrc"
else
    echo "$NAME completion already present in ~/.bashrc"
fi

# Define the line to add $BASE_DIR/$NAME to the PATH
PATH_LINE="export PATH=\$PATH:\"$BASE_DIR/$NAME\""

# Remove any old references to the PATH modification
sed -i "/$BASE_DIR\/$NAME/d" "$BASHRC"

# Add the PATH modification if not already present
if ! grep -Fxq "$PATH_LINE" "$BASHRC"; then
    echo "$PATH_LINE" >> "$BASHRC"
    echo "Added $NAME directory to \$PATH in ~/.bashrc"
else
    echo "$NAME directory already present in \$PATH in ~/.bashrc"
fi

# Show final messages
echo ""
echo "Installation complete!"
echo "Restarting console to apply changes..."
echo ""

# Restart the terminal to apply changes
source ~/.bashrc
